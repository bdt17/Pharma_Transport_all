<!DOCTYPE html>
<html>
<head>
  <title>FDA Compliance Dashboard - Pharma Transport Admin</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
    .header{background:linear-gradient(135deg,#1e40af 0%,#7c3aed 100%);padding:24px 40px}
    .header h1{font-size:28px;font-weight:700}
    .header .subtitle{color:#c7d2fe;font-size:14px;margin-top:4px}
    .nav{background:#1e293b;padding:12px 40px;display:flex;gap:16px;border-bottom:1px solid #334155}
    .nav a{color:#94a3b8;text-decoration:none;padding:8px 16px;border-radius:6px;font-size:14px}
    .nav a:hover,.nav a.active{background:#334155;color:#fff}
    .container{max-width:1600px;margin:0 auto;padding:24px 40px}
    .stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;margin-bottom:24px}
    .stat-card{background:#1e293b;border-radius:12px;padding:20px;text-align:center}
    .stat-card .value{font-size:32px;font-weight:700;color:#3b82f6}
    .stat-card .label{font-size:12px;color:#94a3b8;margin-top:4px;text-transform:uppercase}
    .stat-card.success .value{color:#22c55e}
    .stat-card.warning .value{color:#f59e0b}
    .filters{background:#1e293b;border-radius:12px;padding:20px;margin-bottom:24px;display:flex;gap:16px;flex-wrap:wrap;align-items:end}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-group label{font-size:12px;color:#94a3b8;text-transform:uppercase}
    .filter-group input,.filter-group select{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:8px 12px;color:#e2e8f0;font-size:14px}
    .btn{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:all .2s}
    .btn-primary{background:#3b82f6;color:#fff}
    .btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#334155;color:#e2e8f0}
    .btn-success{background:#22c55e;color:#fff}
    .chain-status{display:flex;align-items:center;gap:8px;padding:12px 20px;border-radius:8px;margin-bottom:24px}
    .chain-status.healthy{background:#166534;border:1px solid #22c55e}
    .chain-status.warning{background:#854d0e;border:1px solid #f59e0b}
    .chain-status .dot{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
    .chain-status.healthy .dot{background:#22c55e}
    .chain-status.warning .dot{background:#f59e0b}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .table-container{background:#1e293b;border-radius:12px;overflow:hidden}
    .table-header{padding:16px 20px;border-bottom:1px solid #334155;display:flex;justify-content:space-between;align-items:center}
    .table-header h2{font-size:16px}
    table{width:100%;border-collapse:collapse}
    th{background:#0f172a;padding:12px 16px;text-align:left;font-size:12px;text-transform:uppercase;color:#94a3b8;font-weight:600}
    td{padding:12px 16px;border-bottom:1px solid #334155;font-size:13px}
    tr:hover{background:#334155}
    .event-type{display:inline-block;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .event-type.billing{background:#3b82f6;color:#fff}
    .event-type.subscription{background:#8b5cf6;color:#fff}
    .event-type.admin{background:#f59e0b;color:#000}
    .event-type.access{background:#64748b;color:#fff}
    .signature{font-family:monospace;font-size:11px;color:#64748b}
    .verified{color:#22c55e}
    .unverified{color:#ef4444}
    .pagination{display:flex;justify-content:center;gap:8px;padding:20px}
    .pagination a{padding:8px 12px;background:#334155;border-radius:6px;color:#e2e8f0;text-decoration:none}
    .pagination a:hover{background:#475569}
    .pagination .current{background:#3b82f6}
    .export-buttons{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="header">
    <h1>FDA 21 CFR Part 11 Compliance Dashboard</h1>
    <p class="subtitle">Immutable Audit Trail Viewer | Pharma Transport Admin</p>
  </div>

  <div class="nav">
    <a href="/admin/compliance" class="active">Audit Trail</a>
    <a href="/admin/compliance/verify">Chain Verification</a>
    <a href="/admin/compliance/report">Compliance Report</a>
    <a href="/dashboard">Back to Dashboard</a>
  </div>

  <div class="container">
    <!-- Chain Status -->
    <div class="chain-status <%= @chain_status[:status] %>">
      <span class="dot"></span>
      <strong>Audit Chain:</strong>
      <span><%= @chain_status[:status].upcase %></span>
      <span style="margin-left:auto;font-size:12px;color:#94a3b8">
        Last sequence: #<%= @chain_status[:last_sequence] %> |
        Last verified: <%= @chain_status[:last_verified] %>
      </span>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="value"><%= number_with_delimiter(@stats[:total_events]) %></div>
        <div class="label">Total Events</div>
      </div>
      <div class="stat-card">
        <div class="value"><%= @stats[:billing_events] %></div>
        <div class="label">Billing Events</div>
      </div>
      <div class="stat-card">
        <div class="value"><%= @stats[:subscription_events] %></div>
        <div class="label">Subscription Events</div>
      </div>
      <div class="stat-card">
        <div class="value"><%= @stats[:admin_events] %></div>
        <div class="label">Admin Events</div>
      </div>
      <div class="stat-card">
        <div class="value"><%= @stats[:unique_tenants] %></div>
        <div class="label">Tenants</div>
      </div>
      <div class="stat-card success">
        <div class="value">100%</div>
        <div class="label">Chain Integrity</div>
      </div>
    </div>

    <!-- Filters -->
    <%= form_tag(admin_compliance_path, method: :get, class: "filters") do %>
      <div class="filter-group">
        <label>Start Date</label>
        <%= date_field_tag :start_date, @start_date, class: "form-control" %>
      </div>
      <div class="filter-group">
        <label>End Date</label>
        <%= date_field_tag :end_date, @end_date, class: "form-control" %>
      </div>
      <div class="filter-group">
        <label>Tenant ID</label>
        <%= text_field_tag :tenant_id, params[:tenant_id], placeholder: "All tenants", class: "form-control" %>
      </div>
      <div class="filter-group">
        <label>Event Type</label>
        <%= select_tag :event_type, options_for_select([
          ["All Types", ""],
          ["Billing", "billing.%"],
          ["Subscription", "subscription.%"],
          ["Admin", "admin.%"],
          ["Access", "access.%"]
        ], params[:event_type]), class: "form-control" %>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <%= submit_tag "Filter", class: "btn btn-primary" %>
      </div>
      <div class="export-buttons" style="margin-left:auto">
        <%= link_to "Export CSV", admin_compliance_export_path(format: :csv, start_date: @start_date, end_date: @end_date), class: "btn btn-secondary" %>
        <%= link_to "Export JSON", admin_compliance_export_path(format: :json, start_date: @start_date, end_date: @end_date), class: "btn btn-secondary" %>
        <%= link_to "Verify Chain", admin_compliance_verify_path, class: "btn btn-success" %>
      </div>
    <% end %>

    <!-- Audit Events Table -->
    <div class="table-container">
      <div class="table-header">
        <h2>Audit Events (<%= @audit_events.total_count %> total)</h2>
      </div>
      <table>
        <thead>
          <tr>
            <th>Seq</th>
            <th>Timestamp</th>
            <th>Type</th>
            <th>Action</th>
            <th>Tenant</th>
            <th>User</th>
            <th>Signature</th>
            <th>Valid</th>
          </tr>
        </thead>
        <tbody>
          <% @audit_events.each do |event| %>
          <tr>
            <td><%= event.sequence %></td>
            <td><%= event.created_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
            <td>
              <% type_class = event.event_type.to_s.split('.').first %>
              <span class="event-type <%= type_class %>"><%= event.event_type %></span>
            </td>
            <td><%= truncate(event.action, length: 50) %></td>
            <td><%= event.tenant_id || "-" %></td>
            <td><%= event.user_id || "System" %></td>
            <td class="signature"><%= event.signature_hash&.first(12) %>...</td>
            <td>
              <% if event.verify_signature %>
                <span class="verified">VALID</span>
              <% else %>
                <span class="unverified">INVALID</span>
              <% end %>
            </td>
          </tr>
          <% end %>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        <% if @audit_events.total_pages > 1 %>
          <%= link_to "First", admin_compliance_path(page: 1, start_date: @start_date, end_date: @end_date) unless @audit_events.first_page? %>
          <%= link_to "Prev", admin_compliance_path(page: @audit_events.prev_page, start_date: @start_date, end_date: @end_date) unless @audit_events.first_page? %>
          <span class="current">Page <%= @audit_events.current_page %> of <%= @audit_events.total_pages %></span>
          <%= link_to "Next", admin_compliance_path(page: @audit_events.next_page, start_date: @start_date, end_date: @end_date) unless @audit_events.last_page? %>
          <%= link_to "Last", admin_compliance_path(page: @audit_events.total_pages, start_date: @start_date, end_date: @end_date) unless @audit_events.last_page? %>
        <% end %>
      </div>
    </div>
  </div>
</body>
</html>

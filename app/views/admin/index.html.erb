<!DOCTYPE html>
<html>
<head>
  <title>ðŸšš Pharma GPS + GEO-FENCING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin:0; font-family: Arial; background:#f0f8ff; padding:10px; }
    .header { background:#007bff; color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:10px; }
    h1 { margin:0; font-size:24px; }
    .stats { display:flex; gap:15px; justify-content:center; margin:10px 0; flex-wrap:wrap; }
    .stat { background:#28a745; padding:10px 20px; border-radius:20px; font-weight:bold; }
    #map { height:70vh; border:3px solid #007bff; border-radius:10px; }
    .update-btn { background:linear-gradient(45deg,#28a745,#20c997); color:white; border:none; padding:15px 30px; border-radius:25px; font-size:18px; font-weight:bold; cursor:pointer; width:100%; margin:10px 0; box-shadow:0 4px 15px rgba(40,167,69,0.4); }
    .update-btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(40,167,69,0.5); }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸšš Pharma GPS + GEO-FENCING</h1>
    <div class="stats">
      <div class="stat">Vehicles: <span id="count">0</span></div>
      <div class="stat" id="status">Loading...</div>
      <div class="stat">Alerts: <span id="alerts">0</span></div>
    </div>
    <button class="update-btn" onclick="updateGPS()">ðŸ”„ LIVE GPS UPDATE</button>
  </div>
  <div id="map"></div>

  <script>
    let map, markers = {}, geofences = [];
    map = L.map('map').setView([35, -113], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    async function loadVehicles() {
      const res = await fetch('/vehicles');
      const vehicles = await res.json();
      document.getElementById('count').textContent = vehicles.length;
      
      vehicles.forEach(v => {
        const lat = parseFloat(v.latitude), lng = parseFloat(v.longitude);
        if (markers[v.id]) markers[v.id].setLatLng([lat, lng]);
        else {
          markers[v.id] = L.marker([lat, lng]).addTo(map)
            .bindPopup(`ðŸšš <b>${v.name}</b><br>ðŸ“ ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        }
      });
    }

    async function loadGeofences() {
      try {
        const res = await fetch('/geofences');
        const fences = await res.json();
        fences.forEach(f => {
          const circle = L.circle([f.latitude, f.longitude], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.2,
            radius: f.radius * 1000
          }).addTo(map).bindPopup(`ðŸš¨ ${f.name}`);
          geofences.push(circle);
        });
      } catch(e) {}
    }

    async function updateGPS() {
      await fetch('/update_gps');
      loadVehicles();
    }

    setInterval(loadVehicles, 10000);
    loadVehicles();
    loadGeofences();
  </script>
</body>
</html>

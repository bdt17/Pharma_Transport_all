<!DOCTYPE html>
<html>
<head>
  <script async defer src="https://maps.googleapis.com/maps/api/js?AIzaSyBWM9oe_9Cvmh30pguQtq8n8TbM_orUiC8&callback=initMap"></script>
</head>

<script>
  App.truckPositions = App.cable.subscriptions.create("TruckPositionChannel", {
    connected() { console.log("üõ∞Ô∏è LIVE TRUCKS CONNECTED"); },
    received(data) {
      const truck = window.trucks?.[data.truck_id];
      if (truck) truck.setPosition({lat: parseFloat(data.lat), lng: parseFloat(data.lng)});
    }
  });
</script>



<body>
<div style="height: 100vh; width: 100%;">
  <div style="padding: 1.5rem; background: linear-gradient(90deg, #0984C0, #60BDD1); color: white;">
    <h1 style="font-size: 2rem; font-weight: 800; margin: 0; display: inline-block; vertical-align: middle;">üöö LIVE GPS TRUCK MAP</h1>
    <a href="/dashboard" style="background: #111827; color: white; font-weight: 700; padding: 0.4rem 1rem; border-radius: 0.4rem; margin-left: 2rem; text-decoration: none; font-size: 0.8rem; border: 1px solid #1f2937; display: inline-block; vertical-align: middle; line-height: 1.3;" 
       onmouseover="this.style.background='#000'; this.style.transform='translateY(-1px)'" 
       onmouseout="this.style.background='#111827'; this.style.transform='translateY(0)'">
      ‚Üê Dashboard
    </a>
  </div>
  <div id="map" style="height: 90vh; width: 100%;"></div>
</div>

<script>
let map;
const trucks = [];
<% if @vehicles && @vehicles.any? %>
  <% @vehicles.each do |v| %>
    trucks.push({
      id: <%= v.id %>,
      lat: <%= v.latitude || 33.4484 %>,
      lng: <%= v.longitude || -112.0740 %>,
      name: "<%= v.name || 'Truck ' + v.id.to_s %>"
    });
  <% end %>
<% end %>

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 10,
    center: { lat: 33.4484, lng: -112.0740 }
  });
  
  // Add truck markers
  trucks.forEach(truck => {
    const marker = new google.maps.Marker({
      position: { lat: truck.lat, lng: truck.lng },
      map: map,
      title: truck.name,
      label: 'üöö',
      icon: {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 6,
        fillColor: '#0984C0',
        fillOpacity: 1,
        strokeWeight: 2
      }
    });
    
    const infoWindow = new google.maps.InfoWindow({
      content: `<strong>${truck.name}</strong><br>Lat: ${truck.lat.toFixed(4)}<br>Lng: ${truck.lng.toFixed(4)}`
    });
    
    marker.addListener('click', () => infoWindow.open(map, marker));
  });
  
  console.log('Map loaded with', trucks.length, 'trucks');
}
</script>
</body>
</html>
